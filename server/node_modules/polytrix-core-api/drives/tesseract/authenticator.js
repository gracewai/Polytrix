var request = require('request');
var Q = require('q');
var Authenticator = require('../authenticator');

module.exports = Authenticator(function(method,access_token,api_url,options){
	options = options || {};
	options.url = api_url;
	options.expectedStatus = options.expectedStatus || 200;
	options.headers = options.headers || {};
	options.headers.Authorization = "bearer " + access_token;
	
	return Q.Promise(function(resolve,reject,notify){
		options.method = method.toUpperCase();
        options.rejectUnauthorized = false;
		request(
			options,
			function(error,response,body){
				if(!error){
					if(response.statusCode == options.expectedStatus){
                        if(response.headers['content-type'].search('application/json') !== -1 && typeof body === 'string'){
                            try{
                                body = JSON.parse(body);
                            }catch(err){
                                console.log(body);
                            }
                        }
                        resolve(body);
					}else{
						console.log('response.statusCode: ' + response.statusCode);
						if(typeof body === 'string'){
							body = JSON.parse(body);
						}
						body.status = response.statusCode;
						console.log(body);
						reject(body);
					}
				}else{
					reject(error);
				}
			}
		);
	});
});