var Q = require('q');
var request = require('request');

// stream
//	createAndUploadStream(access_token,refresh_token,destinationFileId,...(filename,etc.))
//	uploadStream(access_token,refresh_token,fileId,...(patches?))
//	downloadStream(access_token,refresh_token,fileId)

module.exports.createAndUploadStream = function(access_token,refresh_token,destinationFileId,readStream,mimeType,filename){
	return Q.Promise(function(resolve,reject,notify){
		var req = request.put({
			url:'https://api-content.dropbox.com/1/files_put/auto/' + destinationFileId + '/' + filename,
			qs:{
				overwrite:false
			},
			headers:{
				Authorization: "Bearer " + access_token
			}}
		);
		readStream.pipe(req);
		resolve(req);
	});
};
module.exports.uploadStream = function(access_token,refresh_token,fileId,readStream,mimeType,overwrite,parent_rev){//overwirte or upload as a version
	return Q.Promise(function(resolve,reject,notify){
		var options = {
			url:'https://api-content.dropbox.com/1/files_put/auto/' + fileId,
			qs:{
				overwrite:overwrite,
				parent_rev:parent_rev
			},
			headers:{
				Authorization: "Bearer " + access_token
			}
		};
		var req = request.put(options);
		readStream.pipe(req);
		resolve(req);
	});
};
module.exports.downloadStream = function(access_token,refresh_token,fileId){
	return Q.Promise(function(resolve,reject,notify){
		var req = request.get({
			url:'https://api-content.dropbox.com/1/files/auto/' + fileId,
			headers:{
				Authorization: "Bearer " + access_token
			}}
		);
		req.on('response', function(response) {
			resolve(response);
		});
		req.on('error', function(error){
			reject(error);
		});
	});
};
