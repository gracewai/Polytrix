var filefog = require('../filefog');
var Q = require('q');
var Authenticator = require('../authenticator');
// metadata
//	get(access_token,refresh_token,fileId,fileId)
//	listFile(access_token,refresh_token,fileId)
//	downloadUrl(access_token,refresh_token,fileId)

module.exports.get = function(access_token,refresh_token,fileId){
	return filefog.client(access_token,null)
		.then(function (client) {
			return client.getFileInformation(fileId);
		}).then(function(result){
			result.success = true;
			return result;
		}).catch(function (err){
			console.log(err);
			var result = {
				success: false,
				error_code: err.status,
				msg: err.status==404 ? '404 file not found' : err.response.error
			};
			return result;
		});
};

module.exports.listFile = function(access_token,refresh_token,fileId){
	return filefog.client(access_token,null)
	.then(function (client) {
		return client.retrieveFolderItems(fileId);
	}).then(function(result){
		result.success = true;
		return result;
	}).catch(function (err){
		console.log(err);
		var result = {
			success: false,
			error_code: err.status,
			msg: err.status==404 ? '404 file not found' : err.response.error
		};
		return result;
	});
};

module.exports.downloadUrl = function(access_token,refresh_token,fileId){
	return Authenticator.get(access_token,'https://api.dropbox.com/1/media/auto/' + fileId)
	.then(function(body){
		body = JSON.parse(body);
		return body.url;
	});
};

// metadata (folder)
// { is_file: false,
//   is_folder: true,
//   etag: undefined,
//   identifier: '',
//   parent_identifier: '',
//   mimetype: undefined,
//   created_date: Thu Jan 01 1970 08:00:00 GMT+0800 (HKT),
//   modified_date: Thu Jan 01 1970 08:00:00 GMT+0800 (HKT),
//   name: '',
//   description: '',
//   checksum: null,
//   file_size: 0,
//   _raw: 
//    { _json: 
//       { thumb_exists: false,
//         bytes: 0,
//         path: '/',
//         is_dir: true,
//         icon: 'folder',
//         root: 'dropbox',
//         size: '0 bytes' },
//      path: '',
//      name: '',
//      isFolder: true,
//      isFile: false,
//      isRemoved: false,
//      typeIcon: 'folder',
//      modifiedAt: null,
//      clientModifiedAt: null,
//      inAppFolder: false,
//      size: 0,
//      humanSize: '0 bytes',
//      hasThumbnail: false,
//      versionTag: undefined,
//      contentHash: null,
//      mimeType: 'inode/directory' },
//   success: true }




// listFile
// { total_items: null,
//   content: 
//    [ { is_file: true,
//        is_folder: false,
//        etag: '157b1a04db6a',
//        identifier: '/._AST10303-Tut09.doc',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Sun Nov 24 2013 14:27:00 GMT+0800 (HKT),
//        modified_date: Sun Nov 24 2013 14:27:00 GMT+0800 (HKT),
//        name: '._AST10303-Tut09.doc',
//        description: '',
//        checksum: null,
//        file_size: 4096,
//        _raw: [Object] },
//      { is_file: true,
//        is_folder: false,
//        etag: 'dc31a04db6a',
//        identifier: '/a.zip',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Fri Nov 22 2013 16:34:19 GMT+0800 (HKT),
//        modified_date: Fri Nov 22 2013 16:34:19 GMT+0800 (HKT),
//        name: 'a.zip',
//        description: '',
//        checksum: null,
//        file_size: 237154,
//        _raw: [Object] },
//      { is_file: true,
//        is_folder: false,
//        etag: '32531a04db6a',
//        identifier: '/AST10303-Assignment.doc',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Tue Dec 03 2013 11:29:21 GMT+0800 (HKT),
//        modified_date: Tue Dec 03 2013 11:29:21 GMT+0800 (HKT),
//        name: 'AST10303-Assignment.doc',
//        description: '',
//        checksum: null,
//        file_size: 284160,
//        _raw: [Object] },
//      { is_file: true,
//        is_folder: false,
//        etag: '2e6c1a04db6a',
//        identifier: '/AST10303-Tut10.doc',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Sat Nov 30 2013 15:14:41 GMT+0800 (HKT),
//        modified_date: Sat Nov 30 2013 15:14:41 GMT+0800 (HKT),
//        name: 'AST10303-Tut10.doc',
//        description: '',
//        checksum: null,
//        file_size: 66048,
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '71a04db6a',
//        identifier: '/c++',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:06:03 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:03 GMT+0800 (HKT),
//        name: 'c++',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '81a04db6a',
//        identifier: '/co-op',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:06:03 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:03 GMT+0800 (HKT),
//        name: 'co-op',
//        description: '',
//        _raw: [Object] },
//      { is_file: true,
//        is_folder: false,
//        etag: '157e1a04db6a',
//        identifier: '/CTNET.jpg',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Sun Nov 24 2013 14:37:14 GMT+0800 (HKT),
//        modified_date: Sun Nov 24 2013 14:37:14 GMT+0800 (HKT),
//        name: 'CTNET.jpg',
//        description: '',
//        checksum: null,
//        file_size: 194202,
//        _raw: [Object] },
//      { is_file: true,
//        is_folder: false,
//        etag: '2f1f1a04db6a',
//        identifier: '/Drawing3.vsd',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Sun Dec 01 2013 19:45:48 GMT+0800 (HKT),
//        modified_date: Sun Dec 01 2013 19:45:48 GMT+0800 (HKT),
//        name: 'Drawing3.vsd',
//        description: '',
//        checksum: null,
//        file_size: 158208,
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '101a04db6a',
//        identifier: '/graphics',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:06:07 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:07 GMT+0800 (HKT),
//        name: 'Graphics',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '121a04db6a',
//        identifier: '/homework docs',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:06:07 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:07 GMT+0800 (HKT),
//        name: 'Homework Docs',
//        description: '',
//        _raw: [Object] },
//      { is_file: true,
//        is_folder: false,
//        etag: '1dc1a04db6a',
//        identifier: '/LogoDesktop.jpg',
//        parent_identifier: '',
//        mimetype: undefined,
//        created_date: Mon Nov 18 2013 13:06:58 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:58 GMT+0800 (HKT),
//        name: 'LogoDesktop.jpg',
//        description: '',
//        checksum: null,
//        file_size: 109158,
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: 'e1a04db6a',
//        identifier: '/others',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:06:07 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:07 GMT+0800 (HKT),
//        name: 'Others',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '61a04db6a',
//        identifier: '/resources',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:05:57 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:05:57 GMT+0800 (HKT),
//        name: 'resources',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '597d1a04db6a',
//        identifier: '/shared',
//        parent_identifier: '',
//        created_date: Mon Apr 28 2014 13:47:33 GMT+0800 (HKT),
//        modified_date: Mon Apr 28 2014 13:47:33 GMT+0800 (HKT),
//        name: 'Shared',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '46aa1a04db6a',
//        identifier: '/shellext',
//        parent_identifier: '',
//        created_date: Wed Dec 25 2013 01:50:18 GMT+0800 (HKT),
//        modified_date: Wed Dec 25 2013 01:50:18 GMT+0800 (HKT),
//        name: 'shellext',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '31a04db6a',
//        identifier: '/war3',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:05:57 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:05:57 GMT+0800 (HKT),
//        name: 'War3',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '5f1a04db6a',
//        identifier: '/xcode',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 13:06:13 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 13:06:13 GMT+0800 (HKT),
//        name: 'Xcode',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '65c1a04db6a',
//        identifier: '/相機上傳',
//        parent_identifier: '',
//        created_date: Wed Nov 20 2013 11:35:17 GMT+0800 (HKT),
//        modified_date: Wed Nov 20 2013 11:35:17 GMT+0800 (HKT),
//        name: '相機上傳',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '30c1a04db6a',
//        identifier: '/螢幕截圖',
//        parent_identifier: '',
//        created_date: Mon Nov 18 2013 15:04:16 GMT+0800 (HKT),
//        modified_date: Mon Nov 18 2013 15:04:16 GMT+0800 (HKT),
//        name: '螢幕截圖',
//        description: '',
//        _raw: [Object] } ],
//   success: true }