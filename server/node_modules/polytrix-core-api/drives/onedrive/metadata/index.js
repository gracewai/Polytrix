var filefog = require('../filefog');
var Q = require('q');
// metadata
//	get(access_token,refresh_token,fileId)
//	listFile(access_token,refresh_token,fileId)
//	downloadUrl(access_token,refresh_token,fileId)

module.exports.get = function(access_token,refresh_token,fileId){
	return filefog.client(access_token,refresh_token)
	.then(function (client) {
		return client.getFileInformation(fileId);
	}).then(function(result){
		result.success = true;
		if(result._raw.type == 'album'){
			result.is_file = false;
			result.is_folder = true;
		}
		return result;
	}).catch(function (err){
		console.log(err);
		var result = {
			success: false,
			error_code: err.status,
			msg: err.code=='resource_not_found' ? '404 file not found' : err.message
		};
		return result;
	});
};

module.exports.listFile = function(access_token,refresh_token,fileId){
	return filefog.client(access_token,refresh_token)
	.then(function (client) {
		return client.retrieveFolderItems(fileId);
	}).then(function(result){
		result.success = true;
		result.content = result.content.map(function(file){
			if(file._raw.type == 'album'){
				file.is_file = false;
				file.is_folder = true;
			}
			return file;
		});
		return result;
	}).catch(function (err){
		console.log(err);
		var result = {
			success: false,
			error_code: err.status,
			msg: err.code=='resource_not_found' ? '404 file not found' : err.message
		};
		return result;
	});
};

module.exports.downloadUrl = function(access_token,refresh_token,fileId){
	return Authenticator.get(access_token,'https://apis.live.net/v5.0/'+fileId+'/content?suppress_redirects=true&download=true')
	.then(function(body){
		body = JSON.parse(body);
		return body.location;
	});
};

//metadata (folder)
// { is_file: false,
//   is_folder: true,
//   etag: '',
//   identifier: 'folder.e0de0102ecb2448c',
//   parent_identifier: null,
//   mimetype: '',
//   created_date: Thu Jan 01 1970 08:00:00 GMT+0800 (HKT),
//   modified_date: Sat Feb 14 2015 05:36:08 GMT+0800 (HKT),
//   name: 'SkyDrive',
//   description: '',
//   checksum: null,
//   file_size: 114961,
//   _raw: 
//    { id: 'folder.e0de0102ecb2448c',
//      from: { name: null, id: null },
//      name: 'SkyDrive',
//      description: '',
//      parent_id: null,
//      size: 114961,
//      upload_location: 'https://apis.live.net/v5.0/folder.e0de0102ecb2448c/files/',
//      comments_count: 0,
//      comments_enabled: false,
//      is_embeddable: false,
//      count: 4,
//      link: 'https://onedrive.live.com?cid=e0de0102ecb2448c',
//      type: 'folder',
//      shared_with: { access: 'Just me' },
//      created_time: null,
//      updated_time: '2015-02-13T21:36:08+0000',
//      client_updated_time: '2012-11-10T04:58:27+0000' },
//   success: true }



// listFile
// { total_items: null,
//   content: 
//    [ { is_file: false,
//        is_folder: true,
//        etag: '',
//        identifier: 'folder.e0de0102ecb2448c.E0DE0102ECB2448C!593',
//        parent_identifier: 'folder.e0de0102ecb2448c',
//        created_date: Wed Dec 24 2014 19:31:29 GMT+0800 (HKT),
//        modified_date: Wed Dec 24 2014 20:52:36 GMT+0800 (HKT),
//        name: 'test',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '',
//        identifier: 'folder.e0de0102ecb2448c.E0DE0102ECB2448C!105',
//        parent_identifier: 'folder.e0de0102ecb2448c',
//        created_date: Sun Nov 04 2012 20:42:18 GMT+0800 (HKT),
//        modified_date: Thu Nov 22 2012 19:45:05 GMT+0800 (HKT),
//        name: '公用',
//        description: '',
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '',
//        identifier: 'folder.e0de0102ecb2448c.E0DE0102ECB2448C!104',
//        parent_identifier: 'folder.e0de0102ecb2448c',
//        mimetype: '',
//        created_date: Sun Nov 04 2012 20:42:18 GMT+0800 (HKT),
//        modified_date: Thu Nov 22 2012 19:45:05 GMT+0800 (HKT),
//        name: '圖片',
//        description: '',
//        checksum: null,
//        file_size: 0,
//        _raw: [Object] },
//      { is_file: false,
//        is_folder: true,
//        etag: '',
//        identifier: 'folder.e0de0102ecb2448c.E0DE0102ECB2448C!106',
//        parent_identifier: 'folder.e0de0102ecb2448c',
//        created_date: Sun Nov 04 2012 20:42:18 GMT+0800 (HKT),
//        modified_date: Sat Feb 14 2015 05:36:08 GMT+0800 (HKT),
//        name: '文件',
//        description: '',
//        _raw: [Object] } ],
//   success: true }